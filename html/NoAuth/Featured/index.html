% use JSON qw(encode_json);

<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="A list of proposed features for Request Tracker (RT) available for sponsorship.">
    <title>Request Tracker Sponsored Features</title>
    
    <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.0/build/pure-min.css" integrity="sha384-nn4HPE8lTHyVtfCBi5yW9d20FjT8BJwUXyWZT9InLYax14RDjBj46LmSztkmNP9w" crossorigin="anonymous">
    
    <!--[if lte IE 8]>
        <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.0/build/grids-responsive-old-ie-min.css">
    <![endif]-->
    <!--[if gt IE 8]><!-->
        <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.0/build/grids-responsive-min.css"
    <!--<![endif]-->

        <!--[if lte IE 8]>
            <link rel="stylesheet" href="/combo/1.18.13?/css/layouts/pricing-old-ie.css">
        <![endif]-->
        <!--[if gt IE 8]><!-->
            <link rel="stylesheet" href="/static/css/featured-tickets.css">
        <!--<![endif]-->
    <!--[if lt IE 9]>
        <script src="http://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.js"></script>
    <![endif]-->
<!-- Add google analytics tags here -->
</head>
<body>

<div class="logo">
    <a href="https://bestpractical.com" class="logo-link"><img src="https://static.bestpractical.com/bpslogo.png" alt="Best Practical Solutions logo"></a>
</div>

<div class="banner">
    <h1 class="banner-head">
        Request Tracker (RT)<br>
        Sponsor a feature or fix
    </h1>
</div>

<!-- The Modal -->
<div id="myModal" class="modal">
    <!-- Modal content -->
    <div class="modal-content details">
        <h1 class='sponsor-header'>Sponsor This Feature!</h1>
        <h1 id='sponsor-subject'></h1>
        <h3 id='sponsor-details'></h3>
        <h2 id='sponsor-goal'></h2>

        <div>
            <form class='box' action="/NoAuth/Featured">
                <input placeholder="Name" name="Name" type="text">
                <input placeholder="Email" type="email" name="Email" required>
                <input placeholder="Contribution Amount" name="Amount">
                <input name="ticket_id" id='ticket_id' type="hidden">
                <input type="submit" name="Sponsor" value="Submit">
            </form>
        </div>
    </div>
</div>

<script>
    // Get the modal
    var modal = document.getElementById('myModal');

    // Get the button that opens the modal
    var btn = document.getElementById("myBtn");

    // Get the <span> element that closes the modal
    var span = document.getElementsByClassName("close")[0];

    function detailsClicked( args )  {
        var subject = document.getElementById('sponsor-subject');
        var details = document.getElementById('sponsor-details');
        var goal = document.getElementById('sponsor-goal');
        var ticket_id = document.getElementById('ticket_id');

        subject.innerHTML = args['Subject'];
        details.innerHTML = args['Details'];
        goal.innerHTML = args['Goal'];

        ticket_id.value = args['ticket_id'];

        modal.style.display = "block";
    }

    // When the user clicks anywhere outside of the modal, close it
    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }
</script>

<div class="l-content">
    <div class="pricing-tables pure-g">
% while ( my $ticket = $tickets->Next ) {
    <div class="pure-u-1 pure-u-md-1-3">
        <div class="pricing-table pricing-table-free">
            <div class="pricing-table-header">
                <h2><% $ticket->Subject ? $ticket->Subject : 'Ticket: ' . $ticket->Id %></h2>
                    <p class="feature-details"><% $ticket->FirstCustomFieldValue('Description') %></p>
                </div>

                <ul class="pricing-table-list">
                    <li>Awesome point 1</li>
                    <li>Awesome point 2</li>
%   if ( $ticket->FirstCustomFieldValue('Funded') ) {
    <div class='ribbon-wrapper'>
        <div class='ribbon'>Funded!</div>
    </div>
%   }
                </ul>
%   my $args = {'ticket_id' => $ticket->Id, 'Subject' => $ticket->Subject, 'Goal' => $ticket->FirstCustomFieldValue('Goal'), 'Details' => $ticket->FirstCustomFieldValue('Description') };
                    <button onclick="detailsClicked(<% encode_json( $args ) %>)" type="submit" class="button-choose pure-button" value="<% $ticket->Id %>" name="ticket_id">Details</button>
            </div>
        </div>
%}
    </div> <!-- end pricing-tables -->

    <div class="information pure-g">
        <div class="pure-u-1 pure-u-md-1-2">
            <div class="l-box">
                <h3 class="information-head">Get started today</h3>
                <p>
                    Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation.
                </p>
            </div>
        </div>

        <div class="pure-u-1 pure-u-md-1-2">
            <div class="l-box">
                <h3 class="information-head">Pay monthly or annually</h3>
                <p>
                    Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ullamco laboris nisi ut aliquip ex ea commodo
                    consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse.
                </p>
            </div>
        </div>

        <div class="pure-u-1 pure-u-md-1-2">
            <div class="l-box">
                <h3 class="information-head">24/7 customer support</h3>
                <p>
                    Cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum. Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.
                </p>
            </div>
        </div>

        <div class="pure-u-1 pure-u-md-1-2">
            <div class="l-box">
                <h3 class="information-head">Cancel your plan anytime</h3>
                <p>
                    Duis aute irure dolor in reprehenderit in voluptate velit esse
                    cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.
                </p>
            </div>
        </div>
    </div> <!-- end information -->
</div> <!-- end l-content -->

<div class="footer l-box">
    <p>
Header image courtesy of <a href='https://unsplash.com/@rawpixel'>@rawpixel</a> on <a href='http://unsplash.com/'>Unsplash</a>.
    </p>
</div>

</body>
</html>

<%init>
my $queue = RT::Queue->new(RT->SystemUser);
my ($ret, $msg) = $queue->Load(RT->Config->Get('FeaturedTicketsQueue'));
return ($ret, $msg) unless $ret;

my $tickets = RT::Tickets->new(RT->SystemUser);
($ret, $msg) = $tickets->LimitQueue( VALUE => $queue->Name );
return ($ret, $msg) unless $ret;

my $statuses = $queue->CustomFieldValues('Featured statuses');

while (my $status = $statuses->Next() ){
    $tickets->LimitStatus( VALUE => $status->Content);
}

if( $ARGS{Email} ){
    my $ticket = RT::Ticket->new(RT->SystemUser);

    my $parent_ticket = RT::Ticket->new(RT->SystemUser);
    ($ret, $msg) = $parent_ticket->Load( $ARGS{ticket_id} );

    # If ticket fails to load, just load the page - bogus id
    if ( $ret ) {

        my $sponsors = RT::CustomRole->new(RT->SystemUser);
        ($ret, $msg) = $sponsors->Load( 'Sponsors' );
        return ($ret, $msg) unless $ret;

        my $user = RT::User->new(RT->SystemUser);
        ($ret, $msg) = $user->LoadByEmail($ARGS{Email});

        if ( !$ret ) {
            my ($ret, $msg) = $user->Create(
                    RealName           => $ARGS{Name},
                    EmailAddress       => $ARGS{Email},
            );
        return ($ret, $msg) unless $ret;
        }

        if ( $ARGS{Amount} > 0 ) {
            ($ret, $msg) = $ticket->Create(
                Subject       => $ARGS{Name} . " Sponsor Ticket For: \"". $parent_ticket->Subject ."\"",
                Queue         => $queue->Name,
                DependedOnBy  => $ARGS{ticket_id},
                'CustomField-' . $ticket->LoadCustomFieldByIdentifier('Amount')->Id => $ARGS{Amount},
            );
            RT::Logger->error('Could Not Create Linked Ticket') unless $ret;

            ($ret, $msg) = $ticket->AddWatcher( Type => $sponsors->GroupType, PrincipalId => $user->id );
            RT::Logger->error('Couldn\'t Add user as new sponsor') unless $ret;
        }

        ($ret, $msg) = $parent_ticket->AddWatcher( Type => $sponsors->GroupType, PrincipalId => $user->id );
        RT::Logger->debug('Couldn\'t Add user as new sponsor') unless $ret;

        my $new_amount = $ARGS{Amount} + $parent_ticket->FirstCustomFieldValue('Amount');

        ($ret, $msg) = $parent_ticket->AddCustomFieldValue( Field => $parent_ticket->LoadCustomFieldByIdentifier('Amount')->Id, Value => $new_amount );
        RT::Logger->error('Could Not Set Parent Ticket New Amount Value') unless $ret;

        if ( $new_amount >= $parent_ticket->FirstCustomFieldValue('Goal') ) {
            ($ret, $msg) = $parent_ticket->AddCustomFieldValue( Field => $parent_ticket->LoadCustomFieldByIdentifier('Funded')->Id, Value => 'Funded' );
            RT::Logger->error('Failed To Updated Funded Custom Field') unless $ret;
        }

        ($ret, $msg) = $parent_ticket->Comment(
            Content  => 'New sponsor ' . $ARGS{Email} . ', has committed $' . $ARGS{Amount},
        );
        RT::Logger->error('Could not comment on Ticket') unless $ret;
    }
}

</%init>

<%args>
$ticket_id => undef
</%args>
